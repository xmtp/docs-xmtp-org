# Create an XMTP Agent

Create an XMTP agent that can use the signing capabilities provided by the [signer](/agents/core-messaging/create-a-signer). This signer links the agent to the appropriate EOA or SCW.

## Understand creating and building an agent

This video provides a walkthrough of creating and building an agent.

<iframe
  width="560"
  height="315"
  src="https://www.youtube.com/embed/kdUP1ZaauNI?si=ETuEbvwbKx4bjtwc"
  title="YouTube video player"
  frameBorder="0"
  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
  referrerPolicy="strict-origin-when-cross-origin"
  allowFullScreen
></iframe>

### How it works

When you call `Agent.create()`, the following steps happen under the hood:

1. Extracts the `signer` and retrieves the wallet address from it.
2. Checks the XMTP identity ledger to find an inbox ID associated with the signer address. The inbox ID serves as the user's identity on the XMTP network.
   1. If it doesn't find an existing inbox ID, it requests a wallet signature to register the identity and create an inbox ID.
   2. If it finds an existing inbox ID, it uses the existing inbox ID.
3. Checks if a local SQLite database exists. This database contains the identity's installation state and message data.
   1. If it doesn't find an existing local database, it creates one. On non-web platforms, it encrypts the database with the provided `dbEncryptionKey`.
   2. If it finds an existing local database:
      - **For the Node, React Native, Android, and iOS SDKs**: It checks if the provided `dbEncryptionKey` matches. If it matches, it uses the existing database. If not, it creates a new database encrypted with the provided key.
      - **For the Browser SDK**: A `dbEncryptionKey` is not used for encryption due to technical limitations in web environments. Be aware that the database is not encrypted.
4. Returns the XMTP agent, ready to send and receive messages.

### Keep the database encryption key safe

The `dbEncryptionKey` client option is used by the Node, React Native, Android, and Swift SDKs only.

The encryption key encrypts the local SQLite database and must be provided consistently for each agent startup. Store this key securely.

:::warning
If the encryption key is lost or incorrect, the agent will create a new installation and **lose access to all previous messages**.
:::

To learn more about database operations, see the [XMTP MLS protocol spec](https://github.com/xmtp/libxmtp/blob/main/xmtp_mls/README.md).


## Create an agent

To call `Agent.create()`, you must pass in a required `signer` and can also pass in any of the optional parameters covered in [Configure an XMTP agent](#configure-an-xmtp-agent).

```tsx [Node]
import { Agent, createSigner, createUser } from "@xmtp/agent-sdk";
import { getRandomValues } from "node:crypto";

// Option 1: Create a local user + signer (for testing)
const user = createUser();
const signer = createSigner(user);

// Option 2: Use your own wallet signer
// const signer: Signer = { /* ... */ };

/**
 * The database encryption key is optional but strongly recommended for
 * secure local storage of the database.
 *
 * This value must be consistent when creating an agent with an existing
 * database.
 */
const dbEncryptionKey = getRandomValues(new Uint8Array(32));

const agent = await Agent.create(
  signer,
  // agent options
  {
    env: "dev", // or 'production'
    dbEncryptionKey,
    // Optional: Use a function to dynamically set the database path based on inbox ID
    // dbPath: (inboxId) => `./agent-databases/xmtp-${inboxId}.db3`,
  },
);
```

### Configure an XMTP agent

You can configure an XMTP agent with these options passed to `Agent.create`:

```tsx [Node]
import type { ContentCodec } from "@xmtp/content-type-primitives";

type AgentOptions = {
  /**
   * Specify which XMTP environment to connect to. (default: `dev`)
   */
  env?: "local" | "dev" | "production";
  /**
   * Add a client app version identifier that's included with API requests.
   * Production apps are strongly encouraged to set this value.
   *
   * You can use the following format: `appVersion: 'AGENT_NAME/AGENT_VERSION'`.
   * For example, `appVersion: 'alix/2.x'`
   *
   * If you have an agent and an app, it's best to distinguish them from each other by 
   * adding `-agent` and `-app` to the names. For example:
   * - Agent: `appVersion: 'alix-agent/2.x'`
   * - App: `appVersion: 'alix-app/3.x'`
   * 
   * Setting this value provides telemetry that shows which agents are using the
   * XMTP client SDK. This information can help XMTP core developers provide you with agent
   * support, especially around communicating important SDK updates, including
   * deprecations and required upgrades.
   */
  appVersion?: string;
  /**
   * apiUrl can be used to override the `env` flag and connect to a
   * specific endpoint
   */
  apiUrl?: string;
  /**
   * Path to the local DB
   *
   * There are 4 value types that can be used to specify the database path:
   *
   * - `undefined` (or excluded from the client options)
   *    The database will be created in the current working directory and is based on
   *    the XMTP environment and client inbox ID.
   *    Example: `xmtp-dev-<inbox-id>.db3`
   *
   * - `null`
   *    No database will be created and all data will be lost once the client disconnects.
   *
   * - `string`
   *    The given path will be used to create the database.
   *    Example: `./my-db.db3`
   *
   * - `function`
   *    A callback function that receives the inbox ID and returns a string path.
   *    Example: `(inboxId) => string`
   */
  dbPath?: string | null | ((inboxId: string) => string);
  /**
   * Encryption key for the local DB
   */
  dbEncryptionKey?: Uint8Array;
  /**
   * Allow configuring codecs for additional content types
   */
  codecs?: ContentCodec[];
  /**
   * Enable structured JSON logging
   */
  structuredLogging?: boolean;
};
```

### Set the `appVersion` agent option

Be sure to set the `appVersion` agent option for your production agent.

You can use the following format: `appVersion: 'AGENT_NAME/AGENT_VERSION'`.

For example: `appVersion: 'alix/2.x'`

If you have an agent and an app, it's best to distinguish them from each other by adding `-agent` and `-app` to the names. For example:

- Agent: `appVersion: 'alix-agent/2.x'`
- App: `appVersion: 'alix-app/3.x'`

The `appVersion` value is included with API requests to provide telemetry that shows which agents are using the XMTP agent SDK. This information can help XMTP core developers provide you with agent support, especially around communicating important SDK updates, deprecations, and required upgrades.

### XMTP network environments

XMTP provides `dev` and `production` network environments. These networks are completely separate and not interchangeable.

For example, an XMTP identity on the `dev` network is completely distinct from the XMTP identity on the `production` network, as are the messages associated with these identities. In addition, XMTP identities and messages created on the `dev` network can't be accessed from or moved to the `production` network, and vice versa.

:::tip
When you create an agent, it connects to the XMTP `dev` network by default. Set your agent's network environment using the appropriate [agent option](#configure-an-xmtp-agent).
:::

The `production` network is configured to store messages indefinitely. XMTP may occasionally delete messages and identities from the `dev` network, and will provide advance notice in the [XMTP Community Forums](https://community.xmtp.org/).

You can use a `local` network environment to have an agent communicate with an XMTP node you are running locally. During development, using `local` is a great option for speed and reliability. Use the [xmtp-local-node](https://github.com/xmtp/xmtp-local-node/tree/main) repo to easily run a local XMTP node.

## Log out an agent

When you log a user out of your app, you can give them the option to delete their local database.

:::tip[Important]
If the user chooses to delete their local database, they will lose all of their messages and will have to create a new installation the next time they log in.
:::

```tsx [Node]
/**
 * The Agent SDK does not have a method to delete the local database.
 * Simply delete the local database file from the file system.
 */
```
