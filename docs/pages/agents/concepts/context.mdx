# Context and helpers

Every XMTP agent event handler receives a rich `MessageContext` object that provides access to the message, conversation, client, and powerful helper methods. This context makes it easy to build responsive agents without repetitive boilerplate code.

## Message handling

### Type-safe content access

Use type guards to safely access different content types:

```typescript
agent.on('message', async (ctx) => {
  if (ctx.isText()) {
    // ctx.message.content is now typed as string
    console.log('Text message:', ctx.message.content);
  } else if (ctx.isReply()) {
    // ctx.message.content is now typed as Reply
    console.log('Reply to:', ctx.message.content.reference);
    console.log('Reply content:', ctx.message.content.content);
  } else if (ctx.isReaction()) {
    // ctx.message.content is now typed as Reaction
    console.log('Reaction:', ctx.message.content.content);
    console.log('Reference:', ctx.message.content.reference);
  }
});
```

### Message metadata

Access message properties directly:

```typescript
agent.on('message', async (ctx) => {
  const message = ctx.message;
  
  console.log('Message ID:', message.id);
  console.log('Sender inbox ID:', message.senderInboxId);
  console.log('Sent at:', message.sentAt);
  console.log('Content type:', message.contentType);
});
```


### sendText() and sendTextReply()

Send messages and replies:

```typescript
agent.on('text', async (ctx) => {
  // Send a regular message
  await ctx.sendText('Hello!');
  
  // Send a reply to the current message
  await ctx.sendTextReply('Thanks for your message!');
});
```

### sendReaction()

Add reactions to messages:

```typescript
agent.on('text', async (ctx) => {
  const content = ctx.message.content.toLowerCase();
  
  if (content.includes('good')) {
    await ctx.sendReaction('👍');
  } else if (content.includes('bad')) {
    await ctx.sendReaction('👎');
  }
});
```

### getSenderAddress()

Get the Ethereum address of the message sender:

```typescript
agent.on('text', async (ctx) => {
  const senderAddress = await ctx.getSenderAddress();
  console.log('Message from:', senderAddress);
  
  // Use for authorization
  if (senderAddress === '0x1234...') {
    await ctx.sendTextReply('Hello, admin!');
  }
});
```

## Conversation context

### Metadata access

Access conversation properties and check consent states:

```typescript
agent.on('text', async (ctx) => {
  // Check conversation type
  if (ctx.conversation.isDm()) {
    console.log('This is a DM conversation');
  } else if (ctx.conversation.isGroup()) {
    console.log('This is a group conversation');
  }
  
  // Access the conversation object directly
  const conversation = ctx.conversation.conversation;
  console.log('Conversation ID:', conversation.id);
  
  // Check consent state
  if (ctx.conversation.isAllowed) {
    console.log('User has allowed messages');
  } else if (ctx.conversation.isDenied) {
    console.log('User has denied messages');
  } else if (ctx.conversation.isUnknown) {
    console.log('User consent state is unknown');
  }
});
```

### Member information

```typescript
import { IdentifierKind } from '@xmtp/agent-sdk';

agent.on('text', async (ctx) => {
  const members = await ctx.conversation.members();
  
  for (const member of members) {
    console.log('Member inbox ID:', member.inboxId);
    console.log('Permission level:', member.permissionLevel);
    console.log('Consent state:', member.consentState);
    
    // Get Ethereum address
    const ethIdentifier = member.accountIdentifiers.find(
      (id) => id.identifierKind === IdentifierKind.Ethereum
    );
    
    if (ethIdentifier) {
      console.log('Ethereum address:', ethIdentifier.identifier);
    }
  }
});
```

### Message history

```typescript
agent.on('text', async (ctx) => {
  // Get all messages
  const messages = await ctx.conversation.messages();
  console.log('Total messages:', messages.length);
  
  // Get recent messages
  const recentMessages = messages.slice(-10);
  
  for (const msg of recentMessages) {
    console.log(`${msg.senderInboxId}: ${JSON.stringify(msg.content)}`);
  }
});
```


## Client context

```typescript
agent.on('text', async (ctx) => {
  const client = ctx.client;
  
  // Get client address
  const clientAddress = ctx.getClientAddress();
  console.log('Agent address:', clientAddress);
  
  // Access conversations manager
  const conversations = client.conversations;
  
  // Create new conversations
  const newDM = await client.conversations.newDm('target-inbox-id');
  const newGroup = await client.conversations.newGroup(['inbox1', 'inbox2'], {
    groupName: 'New Group',
  });
});
```
