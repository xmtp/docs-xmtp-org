# Enable device sync for apps built with XMTP

Enable the device sync feature to give your users a way to sync decrypted historical data from an existing device to a new device.

This historical data includes:

- Conversations
- Consent states
- HMAC keys (for push notifications)
- Consent and message archive requests

Device sync enables your users pick up conversations where they left off, regardless of the device they use. All they need is a pre-existing and online device to provide the data to a new device.

In this context, the term "device" refers to an app installation on a device.

## ðŸŽ¥ walkthrough: Device sync

This video provides a walkthrough of device sync (formerly known as history sync), covering the key ideas discussed in this doc.

<iframe width="560" height="315" src="https://www.youtube.com/embed/_FtNqtjk-ls?si=uZ_Mnh9phF6y2h-O" title="YouTube video player" frameBorder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerPolicy="strict-origin-when-cross-origin" allowFullScreen></iframe>

## Enable device sync

Device sync is enabled by default and runs automatically. When [creating a client](/inboxes/create-a-client), the `deviceSyncUrl` client option is dynamically set to a default device sync server URL based on your `env` client option setting.

- When `env` is set to `dev`, the `deviceSyncUrl` is set to `https://message-history.dev.ephemera.network/`
- When `env` is set to `production`, the `deviceSyncUrl` is set to `https://message-history.production.ephemera.network`

These default servers are managed and operated by [Ephemera](https://ephemerahq.com/), a steward of the development and adoption of XMTP.

You can choose to [run your own server](https://github.com/xmtp/xmtp-message-history-server) and set the `deviceSyncUrl` to your server's URL.

## How device sync works

When your app initializes an XMTP client and a `deviceSyncUrl` client option is present, device sync automatically triggers an initial sync request and creates an encrypted archive.

<div>
    <img src="https://raw.githubusercontent.com/xmtp/docs-xmtp-org/refs/heads/main/docs/pages/img/device-sync-1.png" width="600px" />
</div>

Device sync then uploads the encrypted archive, and sends a sync reply over the device group. The new device receives the sync reply message, pulls down the encrypted archive from the URL in the message, decrypts the archive using the key in the message, and inserts the consent and message data.

<div>
    <img src="https://raw.githubusercontent.com/xmtp/docs-xmtp-org/refs/heads/main/docs/pages/img/device-sync-2.png" width="600px" />
</div>

Ongoing updates to history are streamed automatically. Updates, whether for user consent preferences or messages, are sent across the device group, ensuring all devices have up-to-date information.

Device syncs are accomplished using these components:

- Device group
- Sync worker
- Device sync server

### Device group

A device group is a special [Messaging Layer Security](/protocol/security) group that includes all of the user's devices. The device group is used to send serialized sync messages of a local device state across a user's other devices. This state information includes:

- Consent
- HMAC keys
- Consent and message archive requests

The device group is filtered out of most queries by default so they don't appear in the user's inbox.

You can sync a local device state across a user's multiple devices independent of the device sync process. To learn more, see [Sync a device group](/inboxes/sync-and-syncall#sync-device-group).

### Sync worker

A sync worker is a spawned background worker that listens for sync events, and processes them accordingly. This worker:

- Emits and updates consent
- Creates and consumes archive payloads for and from other devices
- Keeps preferences synced across devices

### Device sync server

A device sync server acts as a bucket that holds encrypted sync payloads. The URL location of these payloads and the password (cipher encryption key) to decrypt these payloads is sent to the device group for the recipient to decrypt.

## FAQ

### A user logged into a new device and doesn't see their conversations. What's going on?

A debounce feature checks for new devices, at most, once every 30 minutes. To circumvent the cool-down timer, send a message using a pre-existing device.

Once [this issue](https://github.com/xmtp/libxmtp/issues/1309) is resolved, conversations will appear almost instantly.

### A user logged into a new device and sees their conversations, but no messages. What's going on?

Ensure that you've initiated a call to [sync messages](#sync-conversations-and-messages) and that the pre-existing device is online to receive the sync request, process and encrypt the payload, upload it to the device sync server, and send a sync reply message to the new device.

### I called a sync method (messages, consent state, or conversations), but nothing is happening. What's going on?

After requesting a sync for one device, ensure that the pre-existing device is online to receive the sync request.
